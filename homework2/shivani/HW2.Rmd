---
title: "Homework 2"
output: html_document
---
```{r}
library(dplyr)
library(dlookr)
library(lubridate)
```

#Read data
```{r}
covid_df <- read.csv("COVID_19_Nursing_Home_Data_2021_09_12.csv")
covid_df$week_ending <- as.Date(covid_df$week_ending)
```

#Problem 1
```{r}
options(scipen = 999)
vector_len <- c(1000, 100000, 1000000, 10000000)

for(l in vector_len){
  print(paste0("Vector x of length ", l, ":"))
  t1 <- Sys.time()
  x <- 1:l
  for(i in 1:length(x)){
   x[i] <- x[i] * 2
  }
  t2 <- Sys.time()
  time_diff_1 <- t2 - t1
  print(paste0("For loop execution time: ", time_diff_1))
  
  x <- 1:l
  t3 <-Sys.time()
  x <-x*2
  t4<- Sys.time()
  time_diff_2 <- t4 - t3
  print(paste0("Vector operation time: ", time_diff_2))
  
}

#OBSERVATIONS
```
#Problem 2
```{r}
set.seed(3)
frac_rows <- function(df, n = 1000){
  if(!is.numeric(n)){
    stop('This function only works for numeric values of n!\n',
         'You have provided object of the following class:\n',
         'n: ', class(n), '\n')
  }
  len <- dim(df)[1]
  if(len < n){
    stop('The value of n entered is greater than the length of the data frame!\n',
         'Please enter a value less than data frame length to sample the data frame.\n')
  }
  random_index <- runif(n, min = 1, max = len)
  df_subset <- df[random_index,]
  return(df_subset)
}

df_subset <- frac_rows(covid_df, 100)
```

#3.1  Number of nursing home facilities by state and order them in descending order
```{r}
covid_df %>%
  group_by(provider_state) %>%
  summarise(total_facilities = n_distinct(federal_provider_number)) %>%
  arrange(desc(total_facilities))
```
##Verification
```{r}
temp <- covid_df[covid_df$provider_state == "CA",]
length(unique(temp$federal_provider_number ))
```



#3.2 Top five counties by number of nursing home facilities
```{r}
covid_df %>%
  group_by(county) %>%
  summarise(total_facilities = n_distinct(federal_provider_number)) %>%
  arrange(desc(total_facilities)) %>%
  top_n(5)
```


#3.3 Four tables containing the states which experienced more than 20 weeks of shortage of nursing staff (table 1), clinical staff (table 2), aides (table 3), and other staff (table 4)
```{r}
temp <- covid_df %>%
  filter(shortage_of_nursing_staff == "Y") %>%
  group_by(provider_state, federal_provider_number) %>%
  summarise(nursing_staff_shortage = n_distinct(week_ending)) %>%
  filter(nursing_staff_shortage > 20)

covid_df %>% group_by(provider_state) %>%
  summarise(total_facilities = n_distinct(federal_provider_number))
covid_df %>%
  filter(shortage_of_clinical_staff == "Y") %>%
  group_by(provider_state) %>%
  summarise(clinical_staff_shortage = n_distinct(week_ending)) %>%
  filter(clinical_staff_shortage > 20)

covid_df %>%
  filter(shortage_of_aides == "Y") %>%
  group_by(provider_state) %>%
  summarise(aides_shortage = n_distinct(week_ending)) %>%
  filter(aides_shortage > 20)

covid_df %>%
  filter(shortage_of_other_staff == "Y") %>%
  group_by(provider_state) %>%
  summarise(other_staff_shortage = n_distinct(week_ending)) %>%
  filter(other_staff_shortage > 20)
```
```{r}

#ASSUMPTION: We consider a state has shortage of a supply if 30% of facilities in the state have more than 20 weeks of supply shortage

#Total number of facilities in each state, to calculate ratio of shortage facilities
state_facilities <- covid_df %>% group_by(provider_state) %>%
  summarise(total_facilities = n_distinct(federal_provider_number))
#-----------------------------------------
#Calculate number of weeks of shortage for each facility per state and filter facilities that have more than 20 weeks of shortage
shortage_weeks_df <- covid_df %>%
  filter(shortage_of_nursing_staff == "Y") %>%
  group_by(provider_state, federal_provider_number) %>%
  summarise(nursing_staff_shortage = n_distinct(week_ending)) %>%
  filter(nursing_staff_shortage > 20) 
  
#Calculate number of facilities that have more than 20 weeks shortage, grouped by state
state_shortage <- shortage_weeks_df %>% 
  group_by(provider_state) %>%
  summarise(total_shortage_facilities = n())

#Merge total facilities and facilities with 20 weeks shortage by state. Filter states with a 0.3 ratio of shortage facilities: total facilities

final_shortage_df <- merge( state_shortage, state_facilities, by = c("provider_state"))
final_shortage_df %>%
  mutate(shortage_ratio = total_shortage_facilities/total_facilities) %>%
  filter(shortage_ratio > 0.3)
#-------------------------------------------
```
```{r}
#Calculate number of weeks of shortage for each facility per state and filter facilities that have more than 20 weeks of shortage
shortage_weeks_df <- covid_df %>%
  filter(shortage_of_clinical_staff == "Y") %>%
  group_by(provider_state, federal_provider_number) %>%
  summarise(clinical_staff_shortage = n_distinct(week_ending)) %>%
  filter(clinical_staff_shortage > 20) 
  
#Calculate number of facilities that have more than 20 weeks shortage, grouped by state
state_shortage <- shortage_weeks_df %>% 
  group_by(provider_state) %>%
  summarise(total_shortage_facilities = n())

#Merge total facilities and facilities with 20 weeks shortage by state. Filter states with a 0.3 ratio of shortage facilities: total facilities

final_shortage_df <- merge( state_shortage, state_facilities, by = c("provider_state"))
final_shortage_df %>%
  mutate(shortage_ratio = total_shortage_facilities/total_facilities) %>%
  filter(shortage_ratio > 0.05)
```


#3.4 Counties that faced more than 10 weeks shortage of N95 masks (table 1), surgical masks (table 2), eye protection (table 3), supply of gowns (table 4), supply of gloves (table 5), and supply of hand sanitizer (table 6)
```{r}
covid_df %>%
  filter(one_week_supply_of_n95_masks == "N") %>%
  group_by(county) %>%
  summarise(n95_masks_shortage = n_distinct(week_ending)) %>%
  filter(n95_masks_shortage > 10)

covid_df %>%
  filter(one_week_supply_of_surgical_masks == "N") %>%
  group_by(county) %>%
  summarise(surgical_masks_shortage = n_distinct(week_ending)) %>%
  filter(surgical_masks_shortage > 10)

covid_df %>%
  filter(one_week_supply_of_eye_protection == "N") %>%
  group_by(county) %>%
  summarise(eye_protection_shortage = n_distinct(week_ending)) %>%
  filter(eye_protection_shortage > 10)

covid_df %>%
  filter(one_week_supply_of_gowns == "N") %>%
  group_by(county) %>%
  summarise(gowns_shortage = n_distinct(week_ending)) %>%
  filter(gowns_shortage > 10)

covid_df %>%
  filter(one_week_supply_of_gloves == "N") %>%
  group_by(county) %>%
  summarise(gloves_shortage = n_distinct(week_ending)) %>%
  filter(gloves_shortage > 10)

covid_df %>%
  filter(one_week_supply_of_hand_sanitizer == "N") %>%
  group_by(county) %>%
  summarise(hand_sanitizer_shortage = n_distinct(week_ending)) %>%
  filter(hand_sanitizer_shortage > 10)
```
#3.5 All the nursing home facilities that experienced a shortage of ventilator supplies for more than 10 weeks
```{r}
covid_df %>%
  filter(one_week_supply_of_ventilator_supplies == "N") %>%
  group_by(federal_provider_number) %>%
  summarise(total_weeks = n_distinct(week_ending)) %>%
  filter(total_weeks > 10)
```



```{r}
covid_df[covid_df$provider_state == "AK" & covid_df$shortage_of_nursing_staff == "Y",]

covid_df %>%
  filter(shortage_of_clinical_staff == "Y") %>%
  group_by(provider_state)

temp_df <- covid_df %>%
  filter(shortage_of_clinical_staff == "Y") %>%
  group_by(provider_state)

temp_df_2 <- temp_df %>% filter(provider_state == "AK")
n_groups(covid_df)
```










```


```{r}
covid_df[covid_df$provider_state == "AK" & covid_df$shortage_of_nursing_staff == "Y",]

covid_df %>%
  filter(shortage_of_clinical_staff == "Y") %>%
  group_by(provider_state)

temp_df <- covid_df %>%
  filter(shortage_of_clinical_staff == "Y") %>%
  group_by(provider_state)

temp_df_2 <- temp_df %>% filter(provider_state == "AK")
n_groups(covid_df)
```

```{r}
covid_df %>%
  filter(one_week_supply_of_ventilator_supplies == "N") %>%
  group_by(federal_provider_number) %>%
  summarise(total_weeks = n_distinct(week_ending)) %>%
  filter(total_weeks > 20)
```







